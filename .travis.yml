language: rust
cache: cargo
rust:
  - stable
  - beta
  - nightly

addons:
  apt:
    packages:
      - mingw-w64

matrix:
  include:
    - env: TARGET=x86_64-unknown-linux-musl BIN_NAME=genact PROPER_NAME=genact-linux
      os: linux
    - env: TARGET=x86_64-pc-windows-gnu BIN_NAME=genact.exe PROPER_NAME=genact-win.exe RUSTFLAGS="-C linker=x86_64-w64-mingw32-gcc"
      os: linux
    - env: TARGET=x86_64-apple-darwin BIN_NAME=genact PROPER_NAME=genact-osx
      os: osx

  os:
    - linux
    - osx

before_install:
  - rustup self update

install:
  - if [[ -n $TARGET && $TARGET != "x86_64-apple-darwin" ]]; then rustup target add $TARGET; fi

script:
  - if [[ -n $TARGET ]]; then cargo build --verbose --release --target $TARGET; else cargo build --verbose; fi

before_deploy:
  - cp -a target/$TARGET/release/$BIN_NAME $PROPER_NAME

deploy:
  provider: releases
  api_key:
    secure: "n1OCiCjupkVieqsepGBOk6oxGcU89n9z0lQWWMAtBKREIEL1fnqt7A4z9FC1LV9UiAwvcvMHI8As5TA/7sV6jiWFuNOqu5HurX/n7cXlAuVWx00gCtWZ7Fh14ipVIDr2W52Mj/5qw1LSW19g8+9nLF1xO2YLrNpiaQX+V6Ypf04="
  file: $PROPER_NAME
  skip_cleanup: true
  on:
    tags: true
    condition: $TRAVIS_RUST_VERSION = stable
    condition: -n $TARGET
